<!DOCTYPE html>
<html lang="en">
  <head>
    <title>ecsy-three webgl - geometry - cube</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <link type="text/css" rel="stylesheet" href="./assets/main.css" />
    <script type="module" src="//jspm.dev/es-module-shims"></script>
    <script type="importmap-shim" src="/web_modules/import-map.json"></script>
  </head>
  <body>
    <script type="module-shim">
      import { Component, System } from "ecsy";
      import { ECSYThreeWorld, Object3DComponent, Types } from "/src/index.js";
      import {
        initialize,
        // Components
        Parent,
        Camera,
        Transform,
        GLTFLoader,
        // Systems
        WebGLRendererSystem,
        GLTFLoaderSystem,
      } from "/src/extras/index.js";
      import {
        AmbientLight,
        Mesh,
        BoxBufferGeometry,
        MeshBasicMaterial,
        TextureLoader,
      } from "three";

      class Rotating extends Component {}
      Rotating.schema = {
        speed: { default: 1, type: Types.Number },
      };

      class RotationSystem extends System {
        execute(delta) {
          this.queries.entities.results.forEach((entity) => {
            var rotation = entity.getObject3D().rotation;
            rotation.x += 0.5 * delta;
            rotation.y += 0.1 * delta;
          });
        }
      }

      RotationSystem.queries = {
        entities: {
          components: [Rotating, Object3DComponent],
        },
      };

      var world, scene, camera, mesh, renderer;

      init();

      function init() {
        // Create a new world to hold all our entities and systems
        world = new ECSYThreeWorld();

        // Initialize the default sets of entities and systems
        let data = initialize(world);
        console.log(data);

        world.registerComponent(Rotating).registerComponent(GLTFLoader);
        world.registerSystem(GLTFLoaderSystem);
        // Register our custom sytem
        world.registerSystem(RotationSystem);

        // Grab the initialized entities
        let { scene, renderer, camera } = data.entities;
        let scene3d = scene.getObject3D();

        // Modify the position for the default camera
        let camera3d = camera.getObject3D();
        camera3d.position.z = 5;

        world.createEntity().addObject3DComponent(new AmbientLight(), scene);

        // Create an entity to handle our rotating box
        var rotatingBox = world
          .createEntity()
          .addComponent(Rotating)
          .addObject3DComponent(
            new Mesh(
              new BoxBufferGeometry(20, 20, 20),
              new MeshBasicMaterial({
                map: new TextureLoader().load("./assets/crate.gif"),
              })
            ),
            scene
          );
        rotatingBox.remove();
        // rotatingBox should no longer be in the world or the threejs sceen

        var rotatingBox2 = world
          .createEntity()
          .addComponent(Rotating)
          .addObject3DComponent(
            new Mesh(
              new BoxBufferGeometry(1, 1, 1),
              new MeshBasicMaterial({
                map: new TextureLoader().load("./assets/crate.gif"),
              })
            ),
            scene
          );

        var gltfEntity = world
          .createEntity()
          .addComponent(Rotating, { speed: -2 })
          .addComponent(GLTFLoader, {
            url: "./assets/Duck.glb",
            parent: scene,
          });

        // Let's begin
        world.execute();
      }
    </script>
  </body>
</html>
